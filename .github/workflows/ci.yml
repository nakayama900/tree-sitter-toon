name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  test:
    name: Run Tests
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node-version: [18, 20]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
    
    - name: Install pnpm
      uses: pnpm/action-setup@v3
      with:
        version: 8
    
    - name: Install dependencies
      run: pnpm install
    
    - name: Generate parser
      run: pnpm run generate
    
    - name: Run tests
      run: pnpm run test
    
    - name: Upload test results
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.os }}-node${{ matrix.node-version }}
        path: |
          test/**/*.actual
          test/**/*.log
        retention-days: 7

  build-python:
    name: Test Python Package Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine cibuildwheel
    
    - name: Build source distribution
      run: python -m build --sdist
    
    - name: Check package
      run: twine check dist/*

  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
    
    - name: Install pnpm
      uses: pnpm/action-setup@v3
      with:
        version: 8
    
    - name: Install dependencies
      run: pnpm install
    
    - name: Check grammar
      run: pnpm run generate
    
    - name: Verify no changes
      run: |
        git diff --exit-code || (echo "Grammar changes detected. Run 'pnpm run generate' locally." && exit 1)

  summary:
    name: CI Summary
    needs: [test, build-python, lint]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Check results
      run: |
        if [ "${{ needs.test.result }}" == "success" ] && \
           [ "${{ needs.build-python.result }}" == "success" ] && \
           [ "${{ needs.lint.result }}" == "success" ]; then
          echo "✅ All checks passed!"
          exit 0
        else
          echo "❌ Some checks failed:"
          echo "  Tests: ${{ needs.test.result }}"
          echo "  Build: ${{ needs.build-python.result }}"
          echo "  Lint: ${{ needs.lint.result }}"
          exit 1
        fi
